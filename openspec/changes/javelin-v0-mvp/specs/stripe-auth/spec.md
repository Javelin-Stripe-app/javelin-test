## ADDED Requirements

### Requirement: OAuth 2.0 Authorization Flow
The system SHALL authenticate users via Stripe OAuth 2.0. When a user installs Javelin, the app SHALL initiate an OAuth authorization flow using the `oauthContext` provided by the Stripe Apps SDK. The UI SHALL use `createOAuthState()` to generate state and challenge parameters for CSRF protection.

#### Scenario: Successful OAuth authorization
- **WHEN** user installs Javelin and the `oauthContext` contains an authorization `code`
- **THEN** the UI SHALL send the code to the `POST /auth/callback` Edge Function
- **AND** the Edge Function SHALL exchange the code for access and refresh tokens via Stripe's OAuth token endpoint
- **AND** the Edge Function SHALL store the access token (1hr expiry) and refresh token (1yr rolling) in the Stripe Secret Store using `user` scope
- **AND** the UI SHALL display a success state and proceed to the main chat view

#### Scenario: OAuth authorization failure
- **WHEN** user installs Javelin and the `oauthContext` contains an `error` field
- **THEN** the UI SHALL display a Banner (type="critical") explaining the authorization failed
- **AND** the UI SHALL provide a Button to retry the authorization flow

#### Scenario: OAuth state mismatch (CSRF protection)
- **WHEN** the OAuth callback state parameter does not match the state generated by `createOAuthState()`
- **THEN** the system SHALL reject the authorization attempt
- **AND** the UI SHALL display a Banner (type="critical") with a security error message

### Requirement: Token Storage via Secret Store API
The system SHALL persist OAuth tokens exclusively in the Stripe Secret Store API. Tokens SHALL NOT be stored in `.env` files, Supabase, localStorage, or any other storage mechanism.

#### Scenario: Token storage after successful OAuth
- **WHEN** the Edge Function receives valid access and refresh tokens from Stripe
- **THEN** it SHALL store the access token as a Secret Store secret (name: `oauth_access_token`, scope: `user`)
- **AND** it SHALL store the refresh token as a Secret Store secret (name: `oauth_refresh_token`, scope: `user`)
- **AND** the access token secret SHALL include an `expires_at` timestamp matching Stripe's 1hr expiry

#### Scenario: Secret Store limit compliance
- **WHEN** storing OAuth tokens
- **THEN** the system SHALL use no more than 2 of the 10 available user-scoped secret slots
- **AND** the system SHALL verify the `secret_write` permission is declared in `stripe-app.json`

### Requirement: Token Refresh
The system SHALL automatically refresh expired access tokens using the stored refresh token before making Stripe API calls.

#### Scenario: Access token expired, refresh succeeds
- **WHEN** an Edge Function needs to call the Stripe API and the stored access token has expired
- **THEN** the Edge Function SHALL use the refresh token to obtain a new access token from Stripe's OAuth token endpoint
- **AND** the Edge Function SHALL update the access token in the Secret Store
- **AND** the original Stripe API call SHALL proceed with the new access token

#### Scenario: Refresh token expired or revoked
- **WHEN** the refresh token is expired or revoked by Stripe
- **THEN** the Edge Function SHALL return a 401 error with code `auth_refresh_failed`
- **AND** the UI SHALL display a SignInView prompting the user to re-authorize

### Requirement: Request Authentication via Stripe Signature
The system SHALL authenticate all Edge Function requests using `fetchStripeSignature()` from the Stripe Apps SDK. Edge Functions SHALL verify the signature to confirm requests originate from an authenticated Stripe Dashboard session.

#### Scenario: Valid Stripe signature
- **WHEN** the UI sends a request to an Edge Function with a valid Stripe signature header
- **THEN** the Edge Function SHALL verify the signature
- **AND** the Edge Function SHALL extract the `stripe_account_id` and `user_id` from the verified payload
- **AND** the Edge Function SHALL set the RLS context (`app.stripe_account_id`) for database queries

#### Scenario: Missing or invalid signature
- **WHEN** a request arrives at an Edge Function without a valid Stripe signature
- **THEN** the Edge Function SHALL return a 401 error with code `invalid_signature`
- **AND** the Edge Function SHALL NOT execute any database queries or Stripe API calls

### Requirement: Data Deletion on Uninstall
The system SHALL delete all data associated with a Stripe account when Javelin is uninstalled.

#### Scenario: User uninstalls Javelin
- **WHEN** a user uninstalls the Javelin Stripe App
- **THEN** the system SHALL delete all rows in all tables where `stripe_account_id` matches the uninstalling account
- **AND** the system SHALL delete all Secret Store secrets for that user
- **AND** no data SHALL be retained after uninstall

### Requirement: Dual Permission Gate
The system SHALL enforce that API operations never exceed the intersection of app-declared permissions and the signed-in user's Stripe permissions.

#### Scenario: User lacks permission for requested data
- **WHEN** the app requests Stripe data that the signed-in user does not have permission to access
- **THEN** the Stripe API call SHALL fail with a permission error
- **AND** the Edge Function SHALL return a 403 error with code `insufficient_permissions`
- **AND** the UI SHALL display a Banner (type="warning") explaining the user lacks the required Stripe permission

---

**Endpoint Inventory:**

| Method | Path | Auth | Request | Response |
|--------|------|------|---------|----------|
| POST | `/auth/callback` | Stripe signature | `{ code: string, state: string, verifier: string }` | `{ data: { accountId: string } }` |
| POST | `/auth/refresh` | Stripe signature | `{}` | `{ data: { expiresAt: string } }` |
| DELETE | `/account/data` | Stripe signature | `{}` | `{ data: { deleted: true } }` |

**Performance Acceptance Criteria:**
- **PC-1:** Token exchange (OAuth callback) SHALL complete in < 2s
- **PC-2:** Token refresh SHALL complete in < 1s
- **PC-3:** Signature verification SHALL complete in < 100ms

**Security Acceptance Criteria:**
- **SEC-1:** OAuth tokens SHALL never appear in logs, error messages, or client-side code
- **SEC-2:** All Edge Function endpoints SHALL reject requests without valid Stripe signatures
- **SEC-3:** RLS context SHALL be set before any database query in every Edge Function
- **SEC-4:** CSRF protection SHALL be enforced via OAuth state parameter verification
